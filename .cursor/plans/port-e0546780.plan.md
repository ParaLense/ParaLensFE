<!-- e0546780-cc3f-44ae-a206-61cf26a3cc51 89d56956-8a3f-4184-922f-0f70858fb9cb -->
# Port main2.py Pipeline to Vision-Camera FrameProcessor (ROI + Template Decision)

## Decisions

- Keep full flow: Frame → ROI → Contours → Screen candidate (quad) → Homography → Template-Abgleich → Entscheidung.
- ROI is configurable via parameters; enforce minimum aspect ≥ 3:4 centrally.
- Template is optional; if provided, compute accuracy with IoU and gate detection: detected = H valid AND accuracy ≥ 0.8.
- Target canonical screen size: 3:4, 1200×1600. Warped output is disabled by default; when enabled, return 1200×1600 JPEG q=80.

## Files to update

- `ParaLensApp/libs/vision-camera-screen-detector/src/index.tsx` (expose ROI + thresholds in options)
- `ParaLensApp/libs/vision-camera-screen-detector/android/.../ScreenFrameProcessorPlugin.kt` (implement pipeline)
- `ParaLensApp/libs/vision-camera-screen-detector/ios/ScreenFrameProcessor/ScreenFrameProcessor.mm` (mirror pipeline)
- `ParaLensApp/components/TemplateOverlay.tsx` (render explicit ROI boxes)
- `ParaLensApp/components/UiScannerCamera.tsx` (pass ROI, draw only ROI)

## Implementation outline

### 1) TypeScript API and defaults

- Extend `PerformScanOptions`:
  - `roiOuter?: { x; y; width; height }` (normalized 0..1)
  - `roiInner?: { x; y; width; height }` (normalized 0..1)
  - `minAspectW?: number` (default 3), `minAspectH?: number` (default 4)
  - `accuracyThreshold?: number` (default 0.8)
  - Keep `screenAspectW/H` (3/4), `templateTargetW/H` (1200/1600), `returnWarpedImage`, `outputW/H`, `imageQuality`.
- Template array remains supported; if present, compute and return `accuracy` and `matched_boxes`/`template_pixel_boxes`.

### 2) Android pipeline (mirrors main2.py)

- Build gray, rotate 90° CW.
- Resolve ROI pixels from normalized args; enforce min aspect (centered adjust like `adjust_rect_to_ratio`).
- Edges via Canny; extract contours; approximate to quads; choose best screen candidate inside ROI via IoU(bbox, rect) heuristic.
- Order quad corners; compute homography H: image-quad → canonical 3:4 rectangle using `Calib3d.findHomography`.
- If template provided:
  - For each template box in canonical space, project to image using H⁻¹; compute bbox.
  - For each projected bbox, find best IoU vs contour rects; count matches ≥ `minIouForMatch` (e.g., 0.30).
  - `accuracy = matches / templateBoxes.length`.
  - Entscheidung: detected = `H valid` AND `accuracy ≥ accuracyThreshold (0.8)`.
- If no template: detected = `H valid`.
- Optional warp to `outputW×outputH` (default 1200×1600) and encode JPEG q=80.
- Return fields:
  - `width`, `height`, `detected`, `accuracy`, `accuracy_threshold`, `homography`, `homography_inliers_mask?` (if used),
  - `roi_outer_px`, `roi_inner_px`, `screen_rect`, `all_detected_rects`,
  - `template_pixel_boxes?`, `matched_boxes?`,
  - `image_base64?`, `image_format?`, `image_size?`.

### 3) iOS pipeline

- Implement the same steps with OpenCV in Objective-C++:
  - ROI normalization and min-aspect enforcement,
  - Canny → contours → best quad in ROI,
  - Homography image→canonical, template projection with H⁻¹, IoU accuracy, decision, optional warp.
- Maintain identical output keys to Android.

### 4) UI overlays and usage

- In `UiScannerCamera.tsx`:
  - Pass `roiOuter`, `roiInner`, `minAspectW=3`, `minAspectH=4`, `templateTargetW/H=1200/1600`, optional `returnWarpedImage`.
  - Remove ScreenDetection template overlay; render only two ROI boxes using `TemplateOverlay` with explicit `boxes` prop (outer red, inner green).
  - Keep OCR layout based on viewport derived from `template_rect` (outer ROI) and existing mapping.

### 5) Testing

- Android: verify ROI boxes align with preview; check detection toggles only when a plausible rectangular screen is inside ROI; confirm accuracy rises with correct template; validate warped image orientation.
- iOS: repeat tests and ensure parity of fields.

## Key code landmarks (for reference)

- Homography build (image→canonical):
```344:356:ParaLensApp/libs/vision-camera-screen-detector/android/src/main/java/com/Alex8734/visioncamerascreendetector/visioncamerascreendetector/ScreenFrameProcessorPlugin.kt
H = Calib3d.findHomography(src, dst, Calib3d.RANSAC, 3.0)
```

- Template-Abgleich via H⁻¹ and IoU:
```357:390:ParaLensApp/libs/vision-camera-screen-detector/android/src/main/java/com/Alex8734/visioncamerascreendetector/visioncamerascreendetector/ScreenFrameProcessorPlugin.kt
Core.perspectiveTransform(pts, proj, Hinv)
// compute bbox, IoU vs contour rects, accumulate matches → accuracy
```

- Decision combining H and accuracy:
```391:393:ParaLensApp/libs/vision-camera-screen-detector/android/src/main/java/com/Alex8734/visioncamerascreendetector/visioncamerascreendetector/ScreenFrameProcessorPlugin.kt
val detected = (H != null && !H.empty()) && (
  if (templateBoxes != null && templateBoxes.isNotEmpty()) accuracy >= accuracyThreshold else true
)
```